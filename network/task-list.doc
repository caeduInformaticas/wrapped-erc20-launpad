ðŸ† CRED Token - Plan de ImplementaciÃ³n
Sistema de Wrapped ERC-20 con Factory y Gobernanza por Roles
Basado en el enunciado del README: Sistema on-chain para envolver tokens ERC-20 existentes con comisiones en depÃ³sitos y gobernanza por roles, similar a WETH9 pero para cualquier ERC-20.

ðŸ“‹ Roadmap de Tareas EspecÃ­ficas
Phase 1: Tokens Mock y Fundamentos
Task 1.1: Mock Tokens para Testing
Objetivo: Crear tokens ERC-20 de prueba segÃºn especificaciones del README

Criterios del README:

Tokens ERC-20 estÃ¡ndar (saldos, transferencias, approvals)
Soporte opcional para EIP-2612 (permit) para mejor UX
Compatibilidad total con estÃ¡ndar ERC-20
Tests requeridos:

âœ… Deploy y configuraciÃ³n inicial (name, symbol, decimals)
âœ… Funciones bÃ¡sicas: transfer, approve, transferFrom
âœ… Permit functionality (solo en WithPermit version)
âœ… Edge cases: zero transfers, insufficient balance
âœ… Events emitidos correctamente
Phase 2: ERC20Wrapped - Contrato Core
Task 2.1: ERC20Wrapped - Estructura Base
Objetivo: Implementar el wrapper que recibe token subyacente y emite token envuelto

Criterios del README:

Recibe el token subyacente y emite (acuÃ±a) el token envuelto
ParÃ¡metros fijos al despliegue: Subyacente, Fee en depÃ³sito, Factory
Mantener invariante: 1 token envuelto â†” 1 token subyacente en reserva
Tests requeridos:

âœ… Deploy con parÃ¡metros correctos (underlying, fee, factory)
âœ… Variables inmutables configuradas
âœ… Herencia ERC-20 funcional
âœ… Getters para underlying, fee, factory
âœ… Initial supply = 0
Task 2.2: FunciÃ³n Deposit (Wrap) - AprobaciÃ³n ClÃ¡sica
Objetivo: Implementar depÃ³sito segÃºn Flujo 3 del README

Criterios del README:

Usuario entrega el subyacente
Se calcula comisiÃ³n y se envÃ­a al receptor de la fÃ¡brica
Wrapper conserva resto como reserva y emite tokens envueltos
Fee se descuenta del depÃ³sito (usuario recibe menos wrapped)
Tests requeridos:

âœ… Deposit exitoso con cÃ¡lculo de fee correcto
âœ… Fee enviado al receptor actual de factory
âœ… Tokens wrapped emitidos = amount - fee
âœ… Invariante mantenido: wrapped_supply = underlying_reserves
âœ… Revert si amount = 0
âœ… Revert si insufficient allowance
âœ… Event emitido con datos correctos
Task 2.3: FunciÃ³n Withdraw (Unwrap)
Objetivo: Implementar retiro segÃºn Flujo 5 del README

Criterios del README:

Usuario retorna tokens envueltos
Wrapper quema esos tokens y devuelve subyacente desde reserva
No se cobra fee al retirar (segÃºn especificaciÃ³n)
Mantener equivalencia 1:1
Tests requeridos:

âœ… Withdraw exitoso sin fees
âœ… Tokens wrapped quemados correctamente
âœ… Underlying devuelto 1:1 desde reservas
âœ… Invariante mantenido despuÃ©s del withdraw
âœ… Revert si insufficient wrapped balance
âœ… Revert si amount = 0
âœ… Event emitido
Task 2.4: Deposit con Permit (EIP-2612)
Objetivo: Implementar Flujo 4 del README - mejor UX

Criterios del README:

Usuario firma autorizaciÃ³n fuera de cadena (no paga gas)
Wrapper usa firma para obtener permiso en misma transacciÃ³n
Resultado: flujo de depÃ³sito en una sola transacciÃ³n (mejor UX)
Tests requeridos:

âœ… Deposit exitoso con permit signature vÃ¡lida
âœ… Mismo comportamiento que deposit normal
âœ… Revert con signature invÃ¡lida
âœ… Revert con deadline expirado
âœ… Revert si token no soporta permit
âœ… Gas comparison: permit vs approve+deposit
Phase 3: WrapperFactory - FÃ¡brica y Gobernanza
Task 3.1: WrapperFactory - Estructura y Roles
Objetivo: Implementar fÃ¡brica con gobernanza segÃºn punto 4 del README

Criterios del README:

Administrator: gestiona quiÃ©n es Operator y Treasurer
Treasurer: puede cambiar receptor de comisiones
Operator: puede cambiar tasa de fee para futuros wrappers
Receptor de comisiones: direcciÃ³n Ãºnica que fÃ¡brica publica
Fee en depÃ³sito: nÃºmero global para crear wrappers
Tests requeridos:

âœ… Deploy con configuraciÃ³n inicial
âœ… Roles asignados correctamente al deploy
âœ… Solo Administrator puede cambiar roles
âœ… Variables iniciales: feeRecipient, depositFeeRate
âœ… Access control funcionando
âœ… Events para cambios de roles
Task 3.2: Factory - Crear Wrappers
Objetivo: Implementar Flujo 2 del README

Criterios del README:

Cualquiera puede pedir crear wrapper para token subyacente
Verificar que no exista ya wrapper de ese subyacente (unicidad)
Crear ERC20Wrapped con: subyacente, fee actual, direcciÃ³n factory
Evitar duplicados confusos
Tests requeridos:

âœ… Deploy nuevo wrapper exitoso
âœ… Wrapper configurado con parÃ¡metros actuales de factory
âœ… Registro en mapping: underlying â†’ wrapper
âœ… Revert si wrapper ya existe (unicidad)
âœ… Revert si underlying = address(0)
âœ… Event WrapperCreated emitido
âœ… Cualquier usuario puede crear wrapper
Task 3.3: Factory - GestiÃ³n de Fees y Receptores
Objetivo: Implementar Flujos 6 y 7 del README

Criterios del README:

Treasurer puede cambiar receptor de comisiones (Flujo 6)
Operator puede cambiar tasa de fee para futuros wrappers (Flujo 7)
Cambios no afectan wrappers ya desplegados
Wrappers preguntan a factory el receptor vigente en cada depÃ³sito
Tests requeridos:

âœ… Solo Treasurer puede cambiar fee recipient
âœ… Solo Operator puede cambiar fee rate
âœ… Otros roles no pueden hacer cambios
âœ… Fee rate tiene lÃ­mites razonables (ej: max 10%)
âœ… Address zero validation para fee recipient
âœ… Events emitidos para cambios
âœ… Cambios no afectan wrappers existentes
Phase 4: IntegraciÃ³n Factory-Wrapper
Task 4.1: Consulta DinÃ¡mica de Fee Recipient
Objetivo: Wrapper consulta factory para receptor actual (del README)

Criterios del README:

Wrapper pregunta a factory "Â¿QuiÃ©n es hoy el receptor?" en cada depÃ³sito
Permite cambiar destino de comisiones sin redeploy de wrappers
Factory publica receptor Ãºnico, wrappers lo consultan
Tests requeridos:

âœ… Wrapper usa fee recipient actual de factory
âœ… Cambio en factory afecta inmediatamente todos los wrappers
âœ… MÃºltiples wrappers usan mismo recipient
âœ… Revert si factory devuelve address(0)
âœ… Wrapper funciona correctamente tras cambio de recipient
Task 4.2: Actualizabilidad de Factory
Objetivo: Factory actualizable sin romper wrappers existentes (del README)

Criterios del README:

Factory debe poder evolucionar (corregir bugs, aÃ±adir funciones)
No romper wrappers ya creados
Mejorar sistema con el tiempo
Tests requeridos:

âœ… Factory actualizable (proxy pattern)
âœ… Wrappers existentes siguen funcionando tras upgrade
âœ… Nuevos wrappers usan lÃ³gica actualizada
âœ… Datos persistentes tras upgrade (mappings, variables)
âœ… Solo Administrator puede hacer upgrade
Phase 5: Seguridad y Casos Extremos
Task 5.1: Validaciones de Seguridad
Objetivo: Implementar criterios de seguridad del README punto 6

Criterios del README:

No pÃ©rdida de fondos: wrapper mantiene reservas para respaldar suministro
Fee reduce lo que usuario recibe para no "descalzar" reservas vs suministro
Prevenir abuso: nadie puede drenar reservas sin devolver envueltos
Cambios limitados por roles
Tests requeridos:

âœ… Reentrancy protection en deposit/withdraw
âœ… Integer overflow/underflow protection
âœ… Fee calculation mantiene invariantes
âœ… Zero amount validations
âœ… Address zero validations
âœ… Invariante siempre mantenido: reserves >= wrapped_supply
Task 5.2: Tokens Deflacionarios y Edge Cases
Objetivo: Manejar casos mencionados en README punto 6

Criterios del README:

El diseÃ±o asume tokens ERC-20 estÃ¡ndar
Tokens deflacionarios (fee-on-transfer) complican contabilidad
Decidir cÃ³mo tratar estos casos especiales
Tests requeridos:

âœ… Comportamiento con tokens deflacionarios
âœ… Wrapper con fee rate = 0%
âœ… Wrapper con fee rate mÃ¡ximo permitido
âœ… MÃºltiples depÃ³sitos/retiros consecutivos
âœ… Comportamiento con balances muy pequeÃ±os
âœ… Comportamiento con balances = 0
Phase 6: Tests de IntegraciÃ³n E2E
Task 6.1: Flujos Completos del README
Objetivo: Implementar todos los flujos de ejemplo del README

Tests de Flujos EspecÃ­ficos:

âœ… Flujo 1: ConfiguraciÃ³n inicial de fÃ¡brica (roles, fee, recipient)
âœ… Flujo 2: Lanzar nuevo wrapper para token X
âœ… Flujo 3: DepÃ³sito con aprobaciÃ³n clÃ¡sica (MarÃ­a, 100X â†’ 99wX)
âœ… Flujo 4: DepÃ³sito con permit (Juan, 200X â†’ 198wX)
âœ… Flujo 5: Retiro (Ana, 50wX â†’ 50X)
âœ… Flujo 6: Cambiar receptor de comisiones
âœ… Flujo 7: Subir tasa de fee para futuros wrappers
Task 6.2: OptimizaciÃ³n y AnÃ¡lisis Final
Objetivo: OptimizaciÃ³n segÃºn experiencia de usuario del README

Criterios del README:

Con permit, depÃ³sitos son mÃ¡s sencillos (menos pasos, mejor UX)
Gas efficiency importante para adoption
Tests requeridos:

âœ… Gas comparison: permit vs approve+deposit flows
âœ… Factory deployment gas cost
âœ… Wrapper deployment gas cost
âœ… Deposit/withdraw gas costs optimizados
âœ… Multiple users, multiple wrappers stress test
âœ… Performance con high volume operations
ðŸ—ï¸ Arquitectura CRED Token
ðŸŽ¯ Orden de ImplementaciÃ³n CRED Token
Foundation: Task 1.1 (Mock tokens)
Core Wrapper: Tasks 2.1 â†’ 2.2 â†’ 2.3 â†’ 2.4
Factory System: Tasks 3.1 â†’ 3.2 â†’ 3.3
Integration: Tasks 4.1 â†’ 4.2
Security: Tasks 5.1 â†’ 5.2
E2E Validation: Tasks 6.1 â†’ 6.2
âœ… Definition of Done por Task
âœ… ImplementaciÃ³n cumple criterios especÃ­ficos del README
âœ… Todos los tests pasan
âœ… Coverage > 95%
âœ… No warnings de compilaciÃ³n
âœ… Gas costs documentados
âœ… Invariantes del README mantenidos